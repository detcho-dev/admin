<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-2xl font-bold mb-6 text-center">ğŸ“Š Admin Dashboard - Library</h1>

  <!-- === GRID: Leaderboard + Charts === -->
  <div class="grid gap-6 grid-cols-1 md:grid-cols-2 mb-10">
    
    <!-- Leaderboard -->
    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-3">ğŸ† Top Readers</h2>
      <ul id="leaderboardList" class="space-y-2"></ul>
    </div>

    <!-- Most Read Books Chart -->
    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-3">ğŸ“– Most Read Books</h2>
      <canvas id="booksChart"></canvas>
    </div>

    <!-- Section Distribution -->
    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-3">ğŸ“‚ Reads by Section</h2>
      <canvas id="sectionsChart"></canvas>
    </div>

  </div>

  <!-- === Manage Books === -->
  <div class="grid gap-6 grid-cols-1 md:grid-cols-2">

    <!-- Add/Edit Book Form -->
    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-4">â• Add / Edit Book</h2>
      <form id="bookForm" class="grid gap-3">
        <input id="bookId" type="hidden" /> <!-- hidden for edit -->

        <input id="titleInput" type="text" placeholder="Book Title" class="p-2 border rounded" required />
        <input id="authorInput" type="text" placeholder="Author" class="p-2 border rounded" required />
        <input id="pdfInput" type="url" placeholder="PDF URL" class="p-2 border rounded" required />

        <select id="sectionInput" class="p-2 border rounded" required>
          <option value="">-- Select Section --</option>
          <option value="members">Members</option>
          <option value="readers">Readers</option>
        </select>

        <input id="categoriesInput" type="text" placeholder="Categories (comma separated)" class="p-2 border rounded" />

        <button class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Save Book</button>
      </form>
    </div>

    <!-- Books Table -->
    <div class="bg-white shadow rounded-lg p-4 overflow-x-auto">
      <h2 class="text-lg font-semibold mb-4">ğŸ“– Books List</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">Title</th>
            <th class="p-2 border">Author</th>
            <th class="p-2 border">Section</th>
            <th class="p-2 border">Reads</th>
            <th class="p-2 border">Actions</th>
          </tr>
        </thead>
        <tbody id="booksTable"></tbody>
      </table>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { 
  getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs,
  addDoc, updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
  authDomain: "mymlibraryreads.firebaseapp.com",
  projectId: "mymlibraryreads",
  storageBucket: "mymlibraryreads.firebasestorage.app",
  messagingSenderId: "11947740896",
  appId: "1:11947740896:web:87482eb72210acdba50a85"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ===== ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html"; // Ù„Ùˆ Ù…Ø´ Ù„ÙˆØ¬ÙŠÙ† ÙŠØ±Ø¬Ø¹ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  }
});

// ===== Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
const logoutBtn = document.createElement("button");
logoutBtn.textContent = "ğŸšª Logout";
logoutBtn.className = "absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded";
logoutBtn.onclick = () => signOut(auth);
document.body.appendChild(logoutBtn);

// ===== Leaderboard =====
const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
onSnapshot(q, (snapshot) => {
  const leaderboardList = document.getElementById("leaderboardList");
  leaderboardList.innerHTML = "";
  let rank = 0;

  snapshot.forEach((doc) => {
    rank++;
    const data = doc.data();
    const li = document.createElement("li");

    let bgColor = "bg-gray-50"; 
    if (rank === 1) bgColor = "bg-yellow-300";
    else if (rank === 2) bgColor = "bg-gray-300";
    else if (rank === 3) bgColor = "bg-orange-300";

    li.className = `flex justify-between items-center p-2 rounded ${bgColor}`;
    li.innerHTML = `
      <span class="font-bold">#${rank} ${data.name}</span>
      <div class="text-center">
        <span class="font-bold text-lg">${data.score}</span>
        <div class="text-xs text-gray-700">Books</div>
      </div>
    `;
    leaderboardList.appendChild(li);
  });
});

// ===== Charts =====
async function loadBooksChart() {
  const snapshot = await getDocs(collection(db, "Books"));
  const titles = [];
  const reads = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    titles.push(data.Title);
    reads.push(data.Reads || 0);
  });

  new Chart(document.getElementById("booksChart"), {
    type: 'bar',
    data: {
      labels: titles,
      datasets: [{
        label: 'Reads',
        data: reads
      }]
    }
  });
}

async function loadSectionsChart() {
  const snapshot = await getDocs(collection(db, "Books"));
  let members = 0, readers = 0;
  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.Section === "members") members += (data.Reads || 0);
    else readers += (data.Reads || 0);
  });

  new Chart(document.getElementById("sectionsChart"), {
    type: 'pie',
    data: {
      labels: ['Members Books', 'Readers Books'],
      datasets: [{
        data: [members, readers],
        backgroundColor: ["#3b82f6", "#9333ea"]
      }]
    }
  });
}

loadBooksChart();
loadSectionsChart();

// ===== Manage Books =====
const bookForm = document.getElementById("bookForm");
const booksTable = document.getElementById("booksTable");
let editingId = null;

bookForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("titleInput").value.trim();
  const author = document.getElementById("authorInput").value.trim();
  const pdf = document.getElementById("pdfInput").value.trim();
  const section = document.getElementById("sectionInput").value;
  const categories = document.getElementById("categoriesInput").value
    .split(",")
    .map(c => c.trim())
    .filter(c => c);

  if (editingId) {
    const ref = doc(db, "Books", editingId);
    await updateDoc(ref, { Title: title, Author: author, Pdf: pdf, Section: section, Categories: categories });
    editingId = null;
  } else {
    await addDoc(collection(db, "Books"), {
      Title: title,
      Author: author,
      Pdf: pdf,
      Section: section,
      Categories: categories,
      Reads: 0
    });
  }

  bookForm.reset();
});

onSnapshot(collection(db, "Books"), (snapshot) => {
  booksTable.innerHTML = "";
  snapshot.forEach((docSnap) => {
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.className = "border-b";

    tr.innerHTML = `
      <td class="p-2 border">${data.Title}</td>
      <td class="p-2 border">${data.Author}</td>
      <td class="p-2 border">${data.Section}</td>
      <td class="p-2 border text-center">${data.Reads || 0}</td>
      <td class="p-2 border text-center space-x-2">
        <button class="bg-yellow-400 px-2 py-1 rounded editBtn">Edit</button>
        <button class="bg-red-500 text-white px-2 py-1 rounded deleteBtn">Delete</button>
      </td>
    `;

    tr.querySelector(".editBtn").addEventListener("click", () => {
      editingId = docSnap.id;
      document.getElementById("titleInput").value = data.Title;
      document.getElementById("authorInput").value = data.Author;
      document.getElementById("pdfInput").value = data.Pdf;
      document.getElementById("sectionInput").value = data.Section;
      document.getElementById("categoriesInput").value = (data.Categories || []).join(", ");
    });

    tr.querySelector(".deleteBtn").addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this book?")) {
        await deleteDoc(doc(db, "Books", docSnap.id));
      }
    });

    booksTable.appendChild(tr);
  });
});
</script>

</body>
</html>
