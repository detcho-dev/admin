<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Admin Dashboard - Library</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">

Â  <!-- Header -->
<div class="flex flex-col md:flex-row items-center justify-between mb-6">
Â  <h1 class="text-xl md:text-3xl font-bold text-center md:text-left mb-3 md:mb-0">
Â  Â  ğŸ“Š Admin Dashboard - Library
Â  </h1>
Â  <button id="logoutBtn"Â 
Â  Â  class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full md:w-auto">
Â  Â  ğŸšª Logout
Â  </button>
</div>


Â  <!-- === GRID: Leaderboard + Charts === -->
Â  <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mb-10">
Â  Â Â 
Â  Â  <!-- Leaderboard -->
Â  Â  <div class="bg-white shadow rounded-lg p-4">
Â  Â  Â  <h2 class="text-base md:text-lg font-semibold mb-3">ğŸ† Top Readers</h2>
Â  Â  Â  <ul id="leaderboardList" class="space-y-2"></ul>
Â  Â  </div>

Â  Â  <!-- Most Read Books Chart -->
Â  Â  <div class="bg-white shadow rounded-lg p-4">
Â  Â  Â  <h2 class="text-base md:text-lg font-semibold mb-3">ğŸ“– Most Read Books</h2>
Â  Â  Â  <canvas id="booksChart"></canvas>
Â  Â  </div>

Â  Â  <!-- Section Distribution -->
Â  Â  <div class="bg-white shadow rounded-lg p-4">
Â  Â  Â  <h2 class="text-base md:text-lg font-semibold mb-3">ğŸ“‚ Reads by Section</h2>
Â  Â  Â  <canvas id="sectionsChart"></canvas>
Â  Â  </div>

Â  </div>

Â  <!-- === Manage Books === -->
Â  <div class="grid gap-6 grid-cols-1 md:grid-cols-2">
Â  Â Â 
Â  Â  <!-- Add/Edit Book Form -->
Â  Â  <div class="bg-white shadow rounded-lg p-4">
Â  Â  Â  <h2 class="text-base md:text-lg font-semibold mb-4">â• Add / Edit Book</h2>
Â  Â  Â  <form id="bookForm" class="grid gap-3 w-full max-w-md mx-auto md:mx-0">
Â  Â  Â  Â  <input id="bookId" type="hidden" /> <!-- hidden for edit -->

Â  Â  Â  Â  <input id="titleInput" type="text" placeholder="Book Title" class="p-2 border rounded text-sm md:text-base" required />
Â  Â  Â  Â  <input id="authorInput" type="text" placeholder="Author (e.g. Youssef Ahmed)" class="p-2 border rounded text-sm md:text-base" required />
Â  Â  Â  Â  <input id="categoriesInput" type="text" placeholder="Categories (comma separated)" class="p-2 border rounded text-sm md:text-base" />

Â  Â  Â  Â  <input id="coverInput" type="url" placeholder="Cover URL" class="p-2 border rounded text-sm md:text-base" required />
Â  Â  Â  Â  <input id="purchaseTextInput" type="text" placeholder="Purchase Text (e.g. Du - Ø¯Ùˆ [FREE EDITION])" class="p-2 border rounded text-sm md:text-base" required />

Â  Â  Â  Â  <select id="sectionInput" class="p-2 border rounded text-sm md:text-base" required>
Â  Â  Â  Â  Â  <option value="">-- Select Section --</option>
Â  Â  Â  Â  Â  <option value="members">Members</option>
Â  Â  Â  Â  Â  <option value="readers">Readers</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <button class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-sm md:text-base">Save Book</button>
Â  Â  Â  </form>
Â  Â  </div>

Â  Â  <!-- Books Table -->
Â  Â  <div class="bg-white shadow rounded-lg p-4 overflow-x-auto">
Â  Â  Â  <h2 class="text-base md:text-lg font-semibold mb-4">ğŸ“– Books List</h2>
Â  Â  Â  <table class="min-w-[600px] w-full border-collapse text-xs md:text-sm lg:text-base">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr class="bg-gray-200">
Â  Â  Â  Â  Â  Â  <th class="p-2 border">Cover</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 border">Title</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 border">Author</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 border">Section</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 border">Reads</th>
Â  Â  Â  Â  Â  Â  <th class="p-2 border">Actions</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="booksTable"></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {Â 
Â  getFirestore, collection, query, orderBy, limit, getDocs,
Â  setDoc, updateDoc, deleteDoc, doc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

import {Â 
Â  getAuth, onAuthStateChanged, signOutÂ 
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

// ===== Firebase Config =====
const firebaseConfig = {
Â  apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
Â  authDomain: "mymlibraryreads.firebaseapp.com",
Â  projectId: "mymlibraryreads",
Â  storageBucket: "mymlibraryreads.firebasestorage.app",
Â  messagingSenderId: "11947740896",
Â  appId: "1:11947740896:web:87482eb72210acdba50a85"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ===== Auth =====
const allowedAdmin = "mymlibrary@gmail.com";Â 
onAuthStateChanged(auth, (user) => {
Â  if (!user || user.email !== allowedAdmin) {
Â  Â  signOut(auth);
Â  Â  window.location.href = "/login";
Â  }
});

// Logout button
document.getElementById("logoutBtn").onclick = () => signOut(auth);


// ===== Leaderboard =====
const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
onSnapshot(q, (snapshot) => {
Â  const leaderboardList = document.getElementById("leaderboardList");
Â  leaderboardList.innerHTML = "";
Â  let rank = 0;

Â  snapshot.forEach((doc) => {
Â  Â  rank++;
Â  Â  const data = doc.data();
Â  Â  const li = document.createElement("li");

Â  Â  let bgColor = "bg-gray-50";Â 
Â  Â  if (rank === 1) bgColor = "bg-yellow-300";
Â  Â  else if (rank === 2) bgColor = "bg-gray-300";
Â  Â  else if (rank === 3) bgColor = "bg-orange-300";

Â  Â  li.className = `flex justify-between items-center p-2 rounded ${bgColor}`;
Â  Â  li.innerHTML = `
Â  Â  Â  <span class="font-bold">#${rank} ${data.name}</span>
Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  <span class="font-bold text-lg">${data.score}</span>
Â  Â  Â  Â  <div class="text-xs text-gray-700">Books</div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  leaderboardList.appendChild(li);
Â  });
});

// ===== Charts =====
let booksChartInstance = null;
let sectionsChartInstance = null;

async function loadBooksChart() {
Â  const snapshot = await getDocs(collection(db, "Books"));
Â  const titles = [];
Â  const reads = [];
Â  snapshot.forEach(doc => {
Â  Â  const data = doc.data();
Â  Â  titles.push(data.Title || "Untitled");
Â  Â  reads.push(data.Reads || 0);
Â  });

Â  if (booksChartInstance) booksChartInstance.destroy();
Â  booksChartInstance = new Chart(document.getElementById("booksChart"), {
Â  Â  type: 'bar',
Â  Â  data: {
Â  Â  Â  labels: titles,
Â  Â  Â  datasets: [{ label: 'Reads', data: reads }]
Â  Â  }
Â  });
}

async function loadSectionsChart() {
Â  const snapshot = await getDocs(collection(db, "Books"));
Â  let members = 0, readers = 0;
Â  snapshot.forEach(doc => {
Â  Â  const data = doc.data();
Â  Â  if (data.Section === "members") members += (data.Reads || 0);
Â  Â  else if (data.Section === "readers") readers += (data.Reads || 0);
Â  });

Â  if (sectionsChartInstance) sectionsChartInstance.destroy();
Â  sectionsChartInstance = new Chart(document.getElementById("sectionsChart"), {
Â  Â  type: 'pie',
Â  Â  data: {
Â  Â  Â  labels: ['Members Books', 'Readers Books'],
Â  Â  Â  datasets: [{
Â  Â  Â  Â  data: [members, readers],
Â  Â  Â  Â  backgroundColor: ["#3b82f6", "#9333ea"]
Â  Â  Â  }]
Â  Â  }
Â  });
}

loadBooksChart();
loadSectionsChart();

// ===== Manage Books =====
const bookForm = document.getElementById("bookForm");
const booksTable = document.getElementById("booksTable");
let editingId = null;

bookForm.addEventListener("submit", async (e) => {
Â  e.preventDefault();

Â  const title = document.getElementById("titleInput").value.trim();
Â  const author = document.getElementById("authorInput").value.trim();
Â  const categories = document.getElementById("categoriesInput").value
Â  Â  .split(",")
Â  Â  .map(c => c.trim())
Â  Â  .filter(c => c);
Â  const coverURL = document.getElementById("coverInput").value.trim();
Â  const purchaseText = document.getElementById("purchaseTextInput").value.trim();
Â  const section = document.getElementById("sectionInput").value;

Â  if (editingId) {
Â  Â  // === Update Existing Book ===
Â  Â  const ref = doc(db, "Books", editingId);
Â  Â  await updateDoc(ref, {Â 
Â  Â  Â  Title: title,
Â  Â  Â  Author: author,
Â  Â  Â  Categories: categories,
Â  Â  Â  CoverURL: coverURL,
Â  Â  Â  PurchaseText: purchaseText,
Â  Â  Â  Section: section
Â  Â  });
Â  Â  editingId = null;
Â  } else {
Â  Â  // === Add New Book Based on DocumentID field ===
Â  Â  const qLast = query(collection(db, "Books"), orderBy("DocumentID", "desc"), limit(1));
Â  Â  const snapshotLast = await getDocs(qLast);

Â  Â  let newIdNum = 1;
Â  Â  if (!snapshotLast.empty) {
Â  Â  Â  const lastData = snapshotLast.docs[0].data();
Â  Â  Â  newIdNum = parseInt(lastData.DocumentID, 10) + 1;
Â  Â  }
Â  Â  const newId = String(newIdNum).padStart(3, "0");

Â  Â  await setDoc(doc(db, "Books", newId), {
Â  Â  Â  DocumentID: newId,   // ğŸ‘ˆ Ù†Ø®Ø²Ù† Ø±Ù‚Ù… Ø§Ù„ÙƒØªØ§Ø¨
Â  Â  Â  Title: title,
Â  Â  Â  Author: author,
Â  Â  Â  Categories: categories,
Â  Â  Â  CoverURL: coverURL,
Â  Â  Â  PurchaseText: purchaseText,
Â  Â  Â  Section: section,
Â  Â  Â  Reads: 0
Â  Â  });
Â  }

Â  bookForm.reset();
});


// ===== Books Table =====
onSnapshot(collection(db, "Books"), (snapshot) => {
Â  booksTable.innerHTML = "";
Â  snapshot.forEach((docSnap) => {
Â  Â  const data = docSnap.data();
Â  Â  const tr = document.createElement("tr");
Â  Â  tr.className = "border-b";

Â  Â  tr.innerHTML = `
Â  Â  Â  <td class="p-2 border text-center">
Â  Â  Â  Â  <img src="${data.CoverURL}" alt="cover" class="w-12 h-16 object-cover rounded shadow" />
Â  Â  Â  </td>
Â  Â  Â  <td class="p-2 border">${data.Title}</td>
Â  Â  Â  <td class="p-2 border">${data.Author}</td>
Â  Â  Â  <td class="p-2 border">${data.Section}</td>
Â  Â  Â  <td class="p-2 border text-center">${data.Reads || 0}</td>
Â  Â  Â  <td class="p-2 border text-center space-x-2">
Â  Â  Â  Â  <button class="bg-yellow-400 px-2 py-1 rounded editBtn">Edit</button>
Â  Â  Â  Â  <button class="bg-red-500 text-white px-2 py-1 rounded deleteBtn">Delete</button>
Â  Â  Â  </td>
Â  Â  `;

Â  Â  // === Edit ===
Â  Â  tr.querySelector(".editBtn").addEventListener("click", () => {
Â  Â  Â  editingId = docSnap.id;
Â  Â  Â  document.getElementById("titleInput").value = data.Title || "";
Â  Â  Â  document.getElementById("authorInput").value = data.Author || "";
Â  Â  Â  document.getElementById("categoriesInput").value = Array.isArray(data.Categories)Â 
Â  Â  Â  Â  ? data.Categories.join(", ")Â 
Â  Â  Â  Â  : (data.Categories || "");
Â  Â  Â  document.getElementById("coverInput").value = data.CoverURL || "";
Â  Â  Â  document.getElementById("purchaseTextInput").value = data.PurchaseText || "";
Â  Â  Â  document.getElementById("sectionInput").value = data.Section || "";
Â  Â  });

Â  Â  // === Delete ===
Â  Â  tr.querySelector(".deleteBtn").addEventListener("click", async () => {
Â  Â  Â  if (confirm("Are you sure you want to delete this book?")) {
Â  Â  Â  Â  await deleteDoc(doc(db, "Books", docSnap.id));
Â  Â  Â  }
Â  Â  });

Â  Â  booksTable.appendChild(tr);
Â  });

Â  // âœ… Refresh charts when data changes
Â  loadBooksChart();
Â  loadSectionsChart();
});
</script>


</body>
</html>
